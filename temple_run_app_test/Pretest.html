{% extends "global/Page.html" %}
{% block title %}Pretest Task{% endblock %}
{% block content %}

<div id="jspsych-target"></div>
<div id="debug-accuracy" style="
  position: fixed;
  top: 10px;
  right: 20px;
  background-color: rgba(255,255,255,0.9);
  padding: 8px 12px;
  border: 1px solid #aaa;
  border-radius: 5px;
  font-weight: bold;
  color: darkred;
  z-index: 9999;
">
    Debug Accuracy: (waiting...)
</div>

<div id="debug-feedback" style="
  position: fixed;
  top: 150px;
  right: 20px;
  background-color: rgba(255,255,255,0.9);
  padding: 8px 12px;
  border: 1px solid #aaa;
  border-radius: 5px;
  font-weight: bold;
  color: navy;
  z-index: 9999;
">
    Debug Feedback: (waiting...)
</div>

<div id="debug-pretest" style="
  position: fixed;
  top: 230px;
  right: 20px;
  background-color: rgba(255,255,255,0.9);
  padding: 8px 12px;
  border: 1px solid #aaa;
  border-radius: 5px;
  font-weight: bold;
  color: darkgreen;
  z-index: 9999;
">
    Debug Pretest: (waiting...)
</div>


<script src="https://unpkg.com/jspsych@7.3.0"></script>
<script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response"></script>
<script src="https://unpkg.com/@jspsych/plugin-preload"></script>
<script src="https://unpkg.com/@jspsych/plugin-call-function"></script>

<script>
    const jsPsych = initJsPsych({
        display_element: 'jspsych-target',
        on_finish: function () {
            console.log('Done with instructions.');
        }
    });

    const settings = JSON.parse('{{ test_settings|safe }}');

    let stimulusTime = settings.stimulus_time_duration_pretest;
    const seriesData = JSON.parse('{{ series_data|safe }}');

    let digitAccuracy = 0;
    let letterAccuracy = 0;
    let overallAccuracy = 0;
    let correctDigits = 0;
    let correctHitLetters = 0;
    let correctRejectLetters = 0;
    let totalDigits = 0;
    let totalHitLetters = 0;
    let totalRejectLetters = 0;

    const prePreTestThreshold = 0.6;

    let error = 0;
    let accumulatedError = 0;

    let currentPhase = null;

    function resetStats() {
        digitAccuracy = 0;
        letterAccuracy = 0;
        overallAccuracy = 0;
        correctDigits = 0;
        correctHitLetters = 0;
        correctRejectLetters = 0;
        totalDigits = 0;
        totalHitLetters = 0;
        totalRejectLetters = 0;
    }

    function resetDebugInfo() {
        resetStats();
        updateDebugAccuracy();        // redraw the accuracy box -> 0 %
        updateDebugFeedback(null);
        updateDebugPretestInfo();
    }

    const resetTrial = {
        type: jsPsychCallFunction,
        func: () => {
            resetDebugInfo();
        }
    };

    function saveTrialToLocalStorage(trialData) {
        let allData = JSON.parse(localStorage.getItem('autosave_data')) || [];
        allData.push(trialData);
        localStorage.setItem('autosave_data', JSON.stringify(allData));
    }

    const instruction_images = [
        '/static/images/pretest/General_Instructions_REMADE.bmp',
        '/static/images/pretest/Digits_Instructions_REMADE.bmp',
        '/static/images/pretest/Letters_Instructions_REMADE.bmp',
        '/static/images/pretest/Letters_Digits_Instructions_REMADE.bmp'
    ];

    // Show each instruction image, wait for 'y' key to continue
    const generalInstructions = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<img src="/static/images/pretest/General_Instructions_REMADE.bmp" style="max-width: 100%">`,
        choices: ['y']
    };

    const digitsInstructions = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<img src="/static/images/pretest/Digits_Instructions_REMADE.bmp" style="max-width: 100%">`,
        choices: ['y'],
        on_finish: function () {
            currentPhase = "digit training";
        }
    };

    const lettersInstructions = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<img src="/static/images/pretest/Letters_Instructions_REMADE.bmp" style="max-width: 100%">`,
        choices: ['y'],
        on_finish: function () {
            currentPhase = "letter training";
        }
    };

    const lettersDigitsInstructions = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<img src="/static/images/pretest/Letters_Digits_Instructions_REMADE.bmp" style="max-width: 100%">`,
        choices: ['y'],
        on_finish: function () {
            currentPhase = "letter and digit training";
        }
    };

    const stimulusHTML = content => `
      <div style="
        width: 100%;
        height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: black;
        font-size: 72px;
        color: white;
      ">
        ${content}
      </div>
    `;

    const blankScreen = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: stimulusHTML(''),
        choices: "NO_KEYS",
        trial_duration: 100  // 100ms blank
    };

    function makeStimulus(content, choices, correctResponse, trialType) {
        return {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: stimulusHTML(content),
            choices: choices,
            response_ends_trial: false,
            trial_duration: stimulusTime,
            post_trial_gap: 100,
            on_finish: function (data) {
                data.correct = data.response === correctResponse;

                saveTrialToLocalStorage({
                    phase: currentPhase,
                    trial_type: trialType,
                    stimulus: content,
                    response: data.response,
                    correct_response: correctResponse,
                    correct: data.correct,
                    digit_accuracy: digitAccuracy,
                    letter_accuracy: letterAccuracy,
                    overall_accuracy: overallAccuracy,
                    rt: data.rt,
                    timestamp: Date.now()
                });
                updateDebugFeedback(data.correct);
                updateDebugPretestInfo();
                if (trialType === 'digit') {
                    recalculateDigitAccuracy(data.correct);
                } else if (trialType === 'letter') {
                    recalculateLetterAccuracy(data.correct, data.response === ' ');
                }
                updateDebugAccuracy();
            }
        };
    }

    function downloadCSVFromLocalStorage(filename = 'experiment_data.csv') {
        const data = JSON.parse(localStorage.getItem('autosave_data')) || [];

        if (data.length === 0) return;

        // Build CSV header section from settings
        const settingsHeader = ['--- Experiment Settings ---'];
        for (const [key, value] of Object.entries(settings)) {
            settingsHeader.push(`${key},${value}`);
        }

        // Leave a blank line before trial data
        settingsHeader.push('', '--- Trial Data ---');

        // Build data rows
        const keys = Object.keys(data[0]);
        const csvRows = [keys.join(",")];
        for (let row of data) {
            csvRows.push(keys.map(k => JSON.stringify(row[k] ?? '')).join(","));
        }

        const csvString = [...settingsHeader, ...csvRows].join("\n");
        const blob = new Blob([csvString], {type: "text/csv"});
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }


    function recalculateDigitAccuracy(lastAnswerCorrect) {
        if (lastAnswerCorrect) {
            correctDigits++;
        }
        totalDigits++;
        digitAccuracy = correctDigits / totalDigits;
        overallAccuracy = 0.65 * letterAccuracy + 0.35 * digitAccuracy;
    }

    function recalculateLetterAccuracy(lastAnswerCorrect, hit) {
        if (hit) {
            totalHitLetters++;
            if (lastAnswerCorrect) {
                correctHitLetters++;
            }
        } else {
            totalRejectLetters++;
            if (lastAnswerCorrect) {
                correctRejectLetters++;
            }
        }


        const letterHitAccuracy = totalHitLetters > 0 ? correctHitLetters / totalHitLetters : 0;
        const letterRejectionAccuracy = totalRejectLetters > 0 ? correctRejectLetters / totalRejectLetters : 0;

        letterAccuracy = 0.65 * letterHitAccuracy + 0.35 * letterRejectionAccuracy;
        overallAccuracy = 0.65 * letterAccuracy + 0.35 * digitAccuracy;
    }


    const digitTrainingStimuli = ['9', '1', '2',
        //'8', '4', '6', '7', '8', '9', '3', '1',
        '6'];
    const digitTraining = [];
    digitTrainingStimuli.forEach(num => {
        const correctKey = num % 2 === 0 ? '2' : '3';
        digitTraining.push(
            makeStimulus(num, ['2', '3'], correctKey, 'digit')
        );
        digitTraining.push(blankScreen);
    });

    resetDebugInfo();

    const digitTrainingDone = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<p>Well done! Digits training complete.</p><p>Press any key to continue.</p>',
        choices: "ALL_KEYS"
    };

    const letterTrainingStimuli = ['E', 'P', 'P',
        // 'L', 'A', 'P', 'L', 'A', 'A', 'N', 'T', 'N', 'N', 'N', 'U', 'T', 'T', 'P', 'R',
        'R'];
    const letterResponses = ['0', '0', '1', '0'];
    const letterTraining = [];
    for (let i = 0; i < letterTrainingStimuli.length; i++) {
        // Letter
        letterTraining.push(
            makeStimulus(
                letterTrainingStimuli[i],
                [' '],
                letterResponses[i] === '1' ? ' ' : null,
                'letter')
        );
        letterTraining.push(blankScreen);
    }
    ;

    resetDebugInfo();

    const letterTrainingDone = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<p>Well done! Letters training complete.</p><p>Press any key to continue.</p>',
        choices: "ALL_KEYS",
    };


    const getRandomBlock = () => {
        return jsPsych.randomization.sampleWithoutReplacement(seriesData, 1)[0];
    };


    function updateDebugAccuracy() {
        const debugBox = document.getElementById('debug-accuracy');
        if (debugBox) {
            debugBox.innerText =
                `Debug Accuracy:\nOverall: ${(overallAccuracy * 100).toFixed(2)}%\nLetters: ${(letterAccuracy * 100).toFixed(1)}%\nDigits: ${(digitAccuracy * 100).toFixed(1)}%`;
        }
    }


    function updateDebugFeedback(isCorrect) {
        const feedbackBox = document.getElementById('debug-feedback');
        if (isCorrect === null) {
            feedbackBox.innerText = 'Debug Feedback: (waiting…)';
            feedbackBox.style.color = 'navy';
        } else {
            feedbackBox.innerText = `Debug Feedback: ${isCorrect ? "✓ Correct" : "✗ Incorrect"}`;
            feedbackBox.style.color = isCorrect ? 'green' : 'red';
        }
    }

    function updateDebugPretestInfo() {
        const box = document.getElementById('debug-pretest');
        if (box) {
            box.innerText = `Debug Pretest:\nErrors: ${error}\nAccumulated Errors: ${accumulatedError}\nStimulus Duration Time: ${stimulusTime}ms`;
        }
    }


    function makeLetterDigitTimelineFromSeries(block) {
        const trials = [];

        for (let i = 0; i < block.letters.length; i++) {
            const letter = block.letters[i];
            const expected = block.responses[i] === "1" ? " " : null;

            trials.push(makeStimulus(letter, [' '], expected, 'letter'));

            const number = jsPsych.randomization.sampleWithoutReplacement([1, 2, 3, 4, 6, 7, 8, 9], 1)[0];
            const correctKey = number % 2 === 0 ? '2' : '3';

            trials.push(makeStimulus(number, ['2', '3'], correctKey, 'digit'));
        }
        return trials;
    }


    (async () => {
        await jsPsych.run([
            {
                type: jsPsychPreload,
                images: instruction_images
            },
            generalInstructions,
            digitsInstructions,
            ...digitTraining,
            digitTrainingDone,
            resetTrial,
            lettersInstructions,
            ...letterTraining,
            letterTrainingDone,
            resetTrial,
            lettersDigitsInstructions
        ]);

        currentPhase = "pre-pre-test";
        while (overallAccuracy <= prePreTestThreshold) {
            const block = getRandomBlock();
            const trainingTrials = makeLetterDigitTimelineFromSeries(block);

            await jsPsych.run(trainingTrials);

            if (overallAccuracy <= prePreTestThreshold) {
                await jsPsych.run([{
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: '<p>Performance below 85%. Training will repeat.</p><p>Press Y to continue.</p>',
                    choices: ['y']
                }]);

                jsPsych.data.reset();
                resetDebugInfo();
            }
        }

        resetDebugInfo();

        await jsPsych.run([{
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `<p>You have now reached the real pretest!.</p><p>Take a break and wait until the test director gives further instruction before starting. Press 'Y' to begin once you are ready.</p>`,
            choices: ['y']
        }]);

        // actual pretest starts here
        let pretestHCL = null;
        let pretestLCL = null;
        overallAccuracy = 0.99;

        // decreasing since they could handle 1500
        stimulusTime -= 100;
        currentPhase = "pre-test";
        while (overallAccuracy >= 0.01) {
            const block = getRandomBlock();
            resetDebugInfo();
            const trials = makeLetterDigitTimelineFromSeries(block);

            await jsPsych.run(trials);

            if (overallAccuracy < 0.85) {
                error++;
                accumulatedError++;

                // Although this value is fixed to 3 in Borragan & Slama,2017, increasing it at 5 might increase the pretest calibration
                // the subject has had their performance across all tests dip below 85% 3 times. This ends the test. STD is keptat the current value.
                if (error === 3 || accumulatedError === 3) {
                    pretestHCL = stimulusTime + 100;
                    pretestLCL = pretestHCL + 0.5 * pretestHCL;
                    await jsPsych.run([{
                        type: jsPsychHtmlKeyboardResponse,
                        stimulus: `<p>Pretest complete!</p><p>Your HCL is ${pretestHCL} ms and LCL is ${pretestLCL} ms.</p><p>Press any key to finish.</p>`,
                        choices: 'ALL_KEYS'
                    }]);
                    break;
                }

                await jsPsych.run([{
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: `<p>Let's take a break.</p><p>Press 'Y' to begin again when you're ready.</p>`,
                    choices: ['y']
                }]);

                jsPsych.data.reset();
            } else {
                stimulusTime -= 100;
                error = 0;

                await jsPsych.run([{
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: `<p>Let's take a break.</p><p>Press 'Y' to begin again when you're ready.</p>`,
                    choices: ['y']
                }]);

                jsPsych.data.reset();
            }
        }


        downloadCSVFromLocalStorage();

    })();

</script>

{% endblock %}
